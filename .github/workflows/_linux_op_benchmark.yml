name: Linux OP Benchmark Test

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
        default: 'pvc_rolling'
        description: Runner label
      pytorch:
        type: string
        default: 'main'
        description: Pytorch main by default, or 'commit/branch', or 'repo@commit/repo@branch'
      python:
        type: string
        default: '3.10'
        description: Python version

permissions: read-all

defaults:
  run:
    shell: bash -xe {0}
env:
  GH_TOKEN: ${{ github.token }}
  HF_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
  HUGGING_FACE_HUB_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
  DOCKER_REGISTRY_AUTH_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  reference_issue: 1689

jobs:
  runner:
    runs-on: ${{ inputs.runner }}
    name: get-runner
    outputs:
      runner_id: ${{ steps.runner-info.outputs.runner_id }}
      user_id: ${{ steps.runner-info.outputs.user_id }}
      render_id: ${{ steps.runner-info.outputs.render_id }}
      hostname: ${{ steps.runner-info.outputs.hostname }}
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Get runner
        id: runner-info
        uses: ./.github/actions/get-runner

  op_benchmark:
    needs: runner
    runs-on: ${{ needs.runner.outputs.runner_id }}
    timeout-minutes: 900
    container:
      image: intelgpu/ubuntu-24.04-lts2:2523.40
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}
      options: --device=/dev/mem --device=/dev/dri --group-add video --security-opt seccomp=unconfined --cap-add=SYS_PTRACE --shm-size=8g
              -u ${{ needs.runner.outputs.user_id }}:${{ needs.runner.outputs.render_id }}
      env:
        AGENT_TOOLSDIRECTORY: /opt/xpu-tool
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Prepare test env
        uses: ./.github/actions/linux-testenv
        with:
          pytorch: ${{ inputs.pytorch }}
          python: ${{ inputs.python }}
      - name: Run Torch XPU Op Benchmark on ${{ needs.runner.outputs.hostname }}
        run: |
          mkdir -p ${{ github.workspace }}/op_benchmark
          filename=$(find -- test/microbench/ops/*.py)
          ops=$(for f in $filename; do basename "$f" .py; done | paste -sd ' ')
          cd test/microbench
          for i in $ops
          do
            python run.py --op ${i%.*} > ${{ github.workspace }}/op_benchmark/${i%.*}.log
          done
          pip install pandas openpyxl
          # Summary forward op time
          python ${{ github.workspace }}/.github/scripts/microbench_summary.py ${{ github.workspace }}/op_benchmark ${{ github.workspace }}/op_benchmark/forward_op_summary.csv
          # Summary backward op time
          python ${{ github.workspace }}/.github/scripts/microbench_summary.py ${{ github.workspace }}/op_benchmark ${{ github.workspace }}/op_benchmark/backward_op_summary.csv --backward
      - name: Upload Inductor XPU OP benchmark Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/op_benchmark

  result_analysis:
    needs: op_benchmark
    runs-on: ubuntu-24.04
    permissions:
      issues: write
    outputs:
      has_regression: ${{ steps.detect_regression.outputs.has_regression }}
    steps:
      - name: Install gh-cli
        run: |
          sudo apt-get update
          sudo apt-get install gh rsync ca-certificates -y
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Setup python-${{ inputs.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
      - name: Download XPU UT Logs
        uses: actions/download-artifact@v4
        with:
          pattern: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-*
          path: ${{ github.workspace }}/op_benchmark
      - name: Download OP Baseline
        continue-on-error: true
        id: reference_id
        run: |
          # latest dir
          latest_dir=$(find . -type d -name "Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-*" |sort -V |tail -n 1)
          find "${latest_dir}" -type f -name "*.csv" -exec mv {} ${{ github.workspace }}/op_benchmark/ \; || true
          # baseline
          REFERENCE_RUN_ID="$(gh --repo ${GITHUB_REPOSITORY} issue view ${reference_issue} \
            --json body -q .body |grep "Inductor-XPU-OP-Benchmark-Data" |sed 's/.*: *//')"
          rm -rf ${{ github.workspace }}/reference
          mkdir -p ${{ github.workspace }}/reference
          mkdir -p ${{ github.workspace }}/baseline
          if [[ -n "${REFERENCE_RUN_ID}" ]]; then
            echo "Using reference run ID: ${REFERENCE_RUN_ID}"
            gh --repo ${GITHUB_REPOSITORY} run download ${REFERENCE_RUN_ID} -p "Inductor-XPU-OP-Benchmark-Data-*"
            mv -f Inductor-XPU-OP-Benchmark-Data-*-Updated/* ${{ github.workspace }}/reference

            if [[ -f "${{ github.workspace }}/reference/new_baseline/baseline_forward_op_summary.csv" ]]; then
              cp ${{ github.workspace }}/reference/new_baseline/baseline_forward_op_summary.csv ${{ github.workspace }}/baseline
              cp ${{ github.workspace }}/reference/new_baseline/baseline_backward_op_summary.csv ${{ github.workspace }}/baseline
            else
              cp ${{ github.workspace }}/reference/forward_op_summary.csv ${{ github.workspace }}/baseline/baseline_forward_op_summary.csv
              cp ${{ github.workspace }}/reference/backward_op_summary.csv ${{ github.workspace }}/baseline/baseline_backward_op_summary.csv
            fi
          else
            echo "No reference run ID found, using local op_benchmark as baseline"
            cp ${{ github.workspace }}/op_benchmark/forward_op_summary.csv ${{ github.workspace }}/baseline/baseline_forward_op_summary.csv
            cp ${{ github.workspace }}/op_benchmark/backward_op_summary.csv ${{ github.workspace }}/baseline/baseline_backward_op_summary.csv
          fi
          cp -r ${{ github.workspace }}/baseline ${{ github.workspace }}/op_benchmark
      - name: Check the OP Regression
        id: detect_regression
        run: |
          pip install tabulate pandas
          mkdir ${{ github.workspace }}/op_benchmark/rerun_plan
          # Compare forward op
          python ${{ github.workspace }}/.github/scripts/op_perf_comparison.py --xpu_file ${{ github.workspace }}/op_benchmark/forward_op_summary.csv --baseline_file ${{ github.workspace }}/baseline/baseline_forward_op_summary.csv --output-json ${{ github.workspace }}/op_benchmark/rerun_plan/regression_forward_op.json --hide-regression-in-summary
          # Compare backward op
          python ${{ github.workspace }}/.github/scripts/op_perf_comparison.py --xpu_file ${{ github.workspace }}/op_benchmark/backward_op_summary.csv --baseline_file ${{ github.workspace }}/baseline/baseline_backward_op_summary.csv --output-json ${{ github.workspace }}/op_benchmark/rerun_plan/regression_backward_op.json --hide-regression-in-summary
          
          #Count lines (each line = 1 regressed op)
          fwd_count=$(wc -l < ${{ github.workspace }}/op_benchmark/rerun_plan/regression_forward_op.json 2>/dev/null || echo 0)
          bwd_count=$(wc -l < ${{ github.workspace }}/op_benchmark/rerun_plan/regression_backward_op.json 2>/dev/null || echo 0)

          n=$((fwd_count + bwd_count))
          echo "ops_count=$n" >> $GITHUB_OUTPUT
          echo "has_regression=$( [ "$n" -gt 0 ] && echo true || echo false )" >> $GITHUB_OUTPUT
      - name: Upload Inductor XPU OP benchmark rerun cases
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/op_benchmark
          overwrite: true

  op_benchmark_rerun:
    needs: [runner, result_analysis]
    if: needs.result_analysis.outputs.has_regression == 'true'
    runs-on: ${{ needs.runner.outputs.runner_id }}
    timeout-minutes: 600
    container:
      image: intelgpu/ubuntu-22.04-lts2:2523.31
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}
      options: --device=/dev/mem --device=/dev/dri --group-add video --security-opt seccomp=unconfined --cap-add=SYS_PTRACE --shm-size=8g
              -u ${{ needs.runner.outputs.user_id }}:${{ needs.runner.outputs.render_id }}
      env:
        AGENT_TOOLSDIRECTORY: /opt/xpu-tool
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Prepare test env
        uses: ./.github/actions/linux-testenv
        with:
          pytorch: ${{ inputs.pytorch }}
          python: ${{ inputs.python }}
      - name: Download XPU UT Logs
        uses: actions/download-artifact@v4
        with:
          pattern: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-*
          path: ${{ github.workspace }}/op_benchmark
      - name: Rerun regressed ops
        run: |
          cd test/microbench
          mkdir -p ${{ github.workspace }}/op_benchmark/rerun_forward_op_logs
          mkdir -p ${{ github.workspace }}/op_benchmark/rerun_backward_op_logs
          python run_guilt_cases.py ${{ github.workspace }}/op_benchmark/rerun_plan/regression_forward_op.json 3 rerun_forward_op_logs
          python run_guilt_cases.py ${{ github.workspace }}/op_benchmark/rerun_plan/regression_backward_op.json 3 rerun_backward_op_logs

          pip install pandas openpyxl
          # Summary forward op time
          python ${{ github.workspace }}/.github/scripts/microbench_summary.py ${{ github.workspace }}/op_benchmark/rerun_forward_op_logs ${{ github.workspace }}/op_benchmark/rerun_forward_op_summary.csv
          # Summary backward op time
          python ${{ github.workspace }}/.github/scripts/microbench_summary.py ${{ github.workspace }}/op_benchmark/rerun_backward_op_logs ${{ github.workspace }}/op_benchmark/rerun_backward_op_summary.csv --backward

          # Get the best perf of rerun
          python extract_best_perf.py -i ${{ github.workspace }}/op_benchmark/rerun_forward_op_summary.csv -o ${{ github.workspace }}/op_benchmark/rerun_forward_op_summary_filtered.csv
          python extract_best_perf.py -i ${{ github.workspace }}/op_benchmark/rerun_backward_op_summary.csv -o ${{ github.workspace }}/op_benchmark/rerun_backward_op_summary_filtered.csv
      - name: Upload Inductor XPU OP benchmark Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/op_benchmark
          overwrite: true

  op_benchmark_final_test_results_check:
    needs: [result_analysis, op_benchmark_rerun]
    if: always()
    runs-on: ubuntu-24.04
    permissions:
      issues: write
    steps:
      - name: Install gh-cli
        run: |
          sudo apt-get update
          sudo apt-get install gh rsync ca-certificates -y
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Setup python-${{ inputs.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
      - name: Download XPU UT Logs
        uses: actions/download-artifact@v4
        with:
          pattern: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-*
          path: ${{ github.workspace }}/op_benchmark
      - name: Check the OP Regression
        run: |
          latest_dir=$(find . -type d -name "Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-*" |sort -V |tail -n 1)
          mkdir -p ${{ github.workspace }}/op_benchmark/baseline
          find . -type f -name "*.csv" -exec mv {} ${{ github.workspace }}/op_benchmark/ \; || true
          find . -type f -name "baseline*.csv" -exec mv {} ${{ github.workspace }}/op_benchmark/baseline/ \; || true

          pip install tabulate pandas
          # update rerun results
          if [[ needs.result_analysis.outputs.has_regression == 'true' ]]; then
            python ${{ github.workspace }}/test/microbench/update_microbench_perf.py ${{ github.workspace }}/op_benchmark/forward_op_summary.csv ${{ github.workspace }}/op_benchmark/rerun_forward_op_summary_filtered.csv
            python ${{ github.workspace }}/test/microbench/update_microbench_perf.py ${{ github.workspace }}/op_benchmark/backward_op_summary.csv ${{ github.workspace }}/op_benchmark/rerun_backward_op_summary_filtered.csv
            echo "Updated rerun results"
          fi

          # Compare forward op
          python ${{ github.workspace }}/.github/scripts/op_perf_comparison.py --xpu_file ${{ github.workspace }}/op_benchmark/forward_op_summary.csv --baseline_file ${{ github.workspace }}/op_benchmark/baseline/baseline_forward_op_summary.csv --output-json ${{ github.workspace }}/op_benchmark/regression_forward_op_final.json
          # Compare backward op
          python ${{ github.workspace }}/.github/scripts/op_perf_comparison.py --xpu_file ${{ github.workspace }}/op_benchmark/backward_op_summary.csv --baseline_file ${{ github.workspace }}/op_benchmark/baseline/baseline_backward_op_summary.csv --output-json ${{ github.workspace }}/op_benchmark/regression_backward_op_final.json
      - name: Update OP Baseline
        run: |
          pip install tabulate pandas
          mkdir -p ${{ github.workspace }}/new_baseline
          cp ${{ github.workspace }}/op_benchmark/baseline/baseline*.csv ${{ github.workspace }}/new_baseline
          # Update forward op
          python ${{ github.workspace }}/.github/scripts/op_calculate_best_perf.py --xpu ${{ github.workspace }}/op_benchmark/forward_op_summary.csv --baseline ${{ github.workspace }}/new_baseline/baseline_forward_op_summary.csv -r
          # Update backward op
          python ${{ github.workspace }}/.github/scripts/op_calculate_best_perf.py --xpu ${{ github.workspace }}/op_benchmark/backward_op_summary.csv --baseline ${{ github.workspace }}/new_baseline/baseline_backward_op_summary.csv -r
          cp -r ${{ github.workspace }}/new_baseline ${{ github.workspace }}/op_benchmark
      - name: Upload Inductor XPU OP benchmark Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-OP-Benchmark-Data-${{ github.event.pull_request.number || github.sha }}-Updated-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/op_benchmark
      - name: Upload Reference Run ID
        run: |
          gh --repo ${GITHUB_REPOSITORY} issue view ${reference_issue} --json body -q .body | \
            sed "s/Inductor-XPU-OP-Benchmark-Data:.*/Inductor-XPU-OP-Benchmark-Data: ${GITHUB_RUN_ID}/" | sed '/^$/d' > new_body.txt
          gh --repo ${GITHUB_REPOSITORY} issue edit ${reference_issue} --body-file new_body.txt
