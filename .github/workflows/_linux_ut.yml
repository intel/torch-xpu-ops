name: Linux UT Test

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
        description: Runner label
      pytorch:
        type: string
        default: 'main'
        description: Pytorch main by default, or 'commit/branch', or 'repo@commit/repo@branch'
      torch_xpu_ops:
        type: string
        default: 'main'
        description: Torch-xpu-ops version, 'commit/branch', or 'repo@commit/repo@branch', or 'pinned' for pytorch pin
      python:
        type: string
        default: '3.10'
        description: Python version
      ut:
        required: true
        type: string
        description: UT scope. one of `op_regression,op_transformers,op_extended,op_ut,skipped_ut,torch_xpu,op_regression_dev1`
      test_type:
        type: string
        default: "build-cicd"
        description: Test type, default is for CI tests, others (build or wheel)-(nightly, weekly or ondemand)

permissions: read-all

defaults:
  run:
    shell: bash -xe {0}
env:
  GH_TOKEN: ${{ github.token }}
  HF_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
  HUGGING_FACE_HUB_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
  DOCKER_REGISTRY_AUTH_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  UT_SKIP_ISSUE: 1624
  NEW_PASSED_ISSUE: 2333

jobs:
  runner:
    runs-on: ${{ inputs.runner }}
    name: get-runner
    outputs:
      runner_id: ${{ steps.runner-info.outputs.runner_id }}
      user_id: ${{ steps.runner-info.outputs.user_id }}
      render_id: ${{ steps.runner-info.outputs.render_id }}
      hostname: ${{ steps.runner-info.outputs.hostname }}
      pytest_extra_args: ${{ steps.runner-info.outputs.pytest_extra_args }}
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Get runner
        id: runner-info
        with:
          ut_name: ${{ inputs.ut }}
        uses: ./.github/actions/get-runner

  test-in-container:
    needs: runner
    if: ${{ ! contains(inputs.ut, 'distributed') }}
    runs-on: ${{ needs.runner.outputs.runner_id }}
    container:
      image: intelgpu/ubuntu-24.04-lts2:2523.40
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}
      options: --device=/dev/mem --device=/dev/dri --group-add video --security-opt seccomp=unconfined --cap-add=SYS_PTRACE --shm-size=8g
              -u ${{ needs.runner.outputs.user_id }}:${{ needs.runner.outputs.render_id }}
              -e ZE_AFFINITY_MASK
      env:
        AGENT_TOOLSDIRECTORY: /tmp/xpu-tool
        PYTEST_ADDOPTS: -v --timeout 600 --timeout_method=thread --max-worker-restart 1000000
                        --dist worksteal ${{ needs.runner.outputs.pytest_extra_args }}
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Prepare test env
        uses: ./.github/actions/linux-testenv
        with:
          pytorch: ${{ inputs.pytorch }}
          torch_xpu_ops: ${{ inputs.torch_xpu_ops }}
          python: ${{ inputs.python }}
      - name: Run XPU UT Test on ${{ needs.runner.outputs.hostname }}
        uses: ./.github/actions/linux-uttest
        with:
          ut_name: ${{ inputs.ut }}
      - name: Upload Inductor XPU UT Log
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-UT-Data-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/ut_log
          if-no-files-found: ignore
      - name: Upload XPU UT Failure list
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: XPU-UT-Failure-List-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/ut_log/ut_failure_list.csv
          if-no-files-found: ignore

  test-in-baremetal:
    needs: runner
    timeout-minutes: 600
    if: ${{ contains(inputs.ut, 'distributed') }}
    runs-on: ${{ needs.runner.outputs.runner_id }}
    env:
      AGENT_TOOLSDIRECTORY: /tmp/xpu-tool
      PYTEST_ADDOPTS: -v --timeout 3600 --timeout_method=thread -n 1 --max-worker-restart 10000
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Prepare test env
        uses: ./.github/actions/linux-testenv
        with:
          pytorch: ${{ inputs.pytorch }}
          torch_xpu_ops: ${{ inputs.torch_xpu_ops }}
          python: ${{ inputs.python }}
      - name: Run XPU UT Test on ${{ needs.runner.outputs.hostname }}
        uses: ./.github/actions/linux-uttest
        with:
          ut_name: ${{ inputs.ut }}
      - name: Upload Inductor XPU UT Log
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-UT-Data-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/ut_log
          if-no-files-found: ignore
      - name: Upload XPU UT Failure list
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: XPU-UT-Failure-List-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/ut_log/ut_failure_list.csv
          if-no-files-found: ignore

  summary:
    needs: [test-in-container, test-in-baremetal]
    if: ${{ ! cancelled() && ! (endsWith(needs.test-in-container.result, 'ed') && endsWith(needs.test-in-baremetal.result, 'ed')) }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    permissions:
      issues: write
    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Download XPU UT Logs
        uses: actions/download-artifact@v4
        with:
          pattern: Inductor-XPU-UT-Data-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-*
          path: ${{ github.workspace }}/ut_log
      - name: Download Baseline Artifact
        run: |
          mkdir baseline/
          cd baseline/
          if [[ "${{ inputs.test_type }}" != *"ly" ]];then
            artifact_type="$(echo ${{ inputs.test_type }} |awk -F '-' '{print $1}')-nightly"
          else
            artifact_type="${{ inputs.test_type }}"
          fi
          json=$(gh run list \
            --workflow nightly_ondemand.yml \
            --event schedule \
            --repo intel/torch-xpu-ops \
            --limit 50 \
            --json databaseId,displayTitle,status 2>/dev/null)
          get_run_id() {
            local title="$1"
            echo "$json" | jq -r --arg t "$title" '.[] | select(.displayTitle == $t) | select(.status == "completed") | .databaseId' | head -n1
          }
          case "${artifact_type}" in
            "build-nightly")   REFERENCE_RUN_ID="$(get_run_id "Nightly / Build-from-source")" ;;
            "wheel-nightly")   REFERENCE_RUN_ID="$(get_run_id "Nightly / Nightly-wheel")" ;;
            "build-weekly")    REFERENCE_RUN_ID="$(get_run_id "Weekly / Build-from-source")" ;;
            "wheel-weekly")    REFERENCE_RUN_ID="$(get_run_id "Weekly / Nightly-wheel")" ;;
            *)
              echo "⚠️  unknown artifact_type: '${artifact_type}', skip download"
              exit 0
              ;;
          esac
          if [ "${REFERENCE_RUN_ID}" != "" ];then
            echo "✅ Using run ID: ${REFERENCE_RUN_ID} for artifact_type='${artifact_type}'"
            gh --repo intel/torch-xpu-ops run download ${REFERENCE_RUN_ID} -p "Inductor-XPU-UT-Data-*"
            find Inductor-XPU-UT-Data-*/ -type f -path "*/Inductor-XPU-UT-Data-*/*" -print0 | \
              xargs -0 -I {} cp {} .
            rm -rf Inductor-XPU-UT-Data-* || true
          fi
      - name: Check UT Results
        run: |
          ls -al ${{ github.workspace }}/ut_log
          cd ${{ github.workspace }}/ut_log/
          latest_dir=$(find . -type d -name "Inductor-XPU-UT-Data-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-*" |sort -V |tail -n 1)
          cd "${latest_dir}/${{ inputs.ut }}"
          find "${{ github.workspace }}/ut_log" -type f \
              \( -name "failures_*.log" -o \
                -name "passed_*.log" -o \
                -name "category_*.log" -o \
                -name "all_cases_*.log" -o \
                -name "reproduce_*.log" -o \
                -name "test-*.txt" \) \
              -exec mv {} ./ \; || true
          find "${{ github.workspace }}/baseline" -type f -name "test-*.txt" \
            -exec sh -c 'for file; do
                filename=$(basename "$file")
                newname="${filename%.log}_reference.log"
                mv "$file" "./$newname"
              done' _ {} + 2>/dev/null || true
          
          if find "${{ github.workspace }}/baseline" -type f -name "all_cases_*.log" | grep -q .; then
            echo -e "All cases log collect"
            find "${{ github.workspace }}/baseline" -type f -name "all_cases_*.log" \
            -exec sh -c 'for file; do
                filename=$(basename "$file")
                newname="${filename%.log}_reference.log"
                mv "$file" "./$newname"
              done' _ {} + 2>/dev/null || true
          else
            echo -e "No all cases log"
            mkdir -p ${{ github.workspace }}/ut_log/baseline
            find "${{ github.workspace }}/baseline/" -type f \
              \( -name "*.xml" \) \
              -exec mv {} ${{ github.workspace }}/ut_log/baseline \; || true
            pip install junitparser
            python ${{ github.workspace }}/.github/scripts/check-ut.py -n ${{ inputs.ut }} -i ${{ github.workspace }}/ut_log/baseline/*.xml -o ${{ github.workspace }}/ut_log/baseline
            find "${{ github.workspace }}/ut_log/baseline" -type f -name "all_cases_*.log" \
            -exec sh -c 'for file; do
                filename=$(basename "$file")
                newname="${filename%.log}_reference.log"
                mv "$file" "./$newname"
              done' _ {} + 2>/dev/null || true
          fi
          cp ${{ github.workspace }}/.github/scripts/ut_result_check.sh ./
          # get distributed known issues
          gh --repo intel/torch-xpu-ops issue view $UT_SKIP_ISSUE --json body -q .body |sed -E '/^(#|$)/d' > Known_issue.log.tmp
          # get skipped known issues
          count=$(gh api "search/issues?q=repo:$GITHUB_REPOSITORY+label:skipped+state:open" --jq '.total_count')
          if [ "$count" -gt 0 ]; then
            echo -e "$count issues with skipped label found"
            gh api --paginate "repos/${{ github.repository }}/issues?labels=skipped" \
              --jq '.[] | select(.pull_request == null) | "Issue #\(.number): \(.title)\n\(.body)\n"' > issues.log
          fi
          if [ "${{ inputs.ut }}" == "basic" ];then
            ut_list="op_regression op_transformers op_extended op_regression_dev1"
          else
            ut_list="${{ inputs.ut }}"
          fi
          for ut_name in ${ut_list}
          do
            cp Known_issue.log.tmp Known_issue.log
            awk -v r="${ut_name}" 'BEGIN{ print_row = 0 }{
              if ( ! ( $0 ~ /[a-zA-Z0-9]/ ) ) { print_row = 0 };
              if ( print_row == 1 && $1 ~ r ) { print $0 };
              if ( $0 ~ /Cases:/ ) { print_row = 1 };
            }' issues.log >> Known_issue.log
            sed -i 's/[[:space:]]*$//g' Known_issue.log
            bash ut_result_check.sh "${ut_name}" "${{ inputs.pytorch }}"
          done
      - name: Upload Inductor XPU UT Log
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Inductor-XPU-UT-Data-${{ github.event.pull_request.number || github.sha }}-${{ inputs.ut }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ github.workspace }}/ut_log
          overwrite: true
