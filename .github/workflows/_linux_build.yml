name: Linux PyTorch XPU Build

on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
        default: 'pvc_rolling'
        description: Runner label
      test_type:
        type: string
        default: 'build-from-source'
        description: Build from source or install nightly wheel
      pytorch:
        type: string
        default: 'main'
        description: Pytorch main by default, or 'commit/branch', or 'repo@commit/repo@branch'
      torch_xpu_ops:
        type: string
        default: 'main'
        description: Torch-xpu-ops main by default, 'commit/branch', or 'repo@commit/repo@branch', or 'pinned' for pytorch pin
      triton:
        required: false
        type: string
        default: 'pinned'
        description: Triton pinned by pytorch by default, or 'commit/branch', or 'repo@commit/repo@branch'
      oneapi:
        type: string
        default: 'installed'
        description: Installed oneAPI DLE on host by default, fill offline.sh url if needed
      python:
        type: string
        default: '3.10'
        description: Python version

permissions: read-all

jobs:
  wheel:
    if: ${{ contains(inputs.test_type, 'wheel') }}
    name: ${{ inputs.pytorch }}
    runs-on: ubuntu-latest
    steps:
      - name: Use ${{ inputs.pytorch }}
        run: echo 'Use ${{ inputs.pytorch }}'
  get_build_runner:
    if: ${{ ! contains(inputs.test_type, 'wheel') }}
    runs-on: ${{ inputs.runner }}
    outputs:
      test_host: ${{ steps.runner-info.outputs.test_host }}
      test_user: ${{ steps.runner-info.outputs.test_user }}
      test_group: ${{ steps.runner-info.outputs.test_group }}
    steps:
      - name: Get runner info
        id: runner-info
        run: |
          # get test runner
          echo "test_host=${RUNNER_NAME}" |tee -a ${GITHUB_OUTPUT}
          echo "test_user=$(id -u)" |tee -a ${GITHUB_OUTPUT}
          echo "test_group=$(getent group render |cut -d: -f3)" |tee -a ${GITHUB_OUTPUT}
          # show host info
          cat /etc/os-release
          uname -a
          source /opt/intel/oneapi/setvars.sh
          sycl-ls
          dpkg -l |grep -E 'libigc-dev|libze-dev|level-zero-dev'
      - name: Cleanup workspace
        if: ${{ always() }}
        run: |
          # clean docker cache
          docker stop $(docker ps -aq) || true
          docker system prune -af || true
          # clean files
          ls -al
          sudo find ./ |grep -v "^\./$" |xargs sudo rm -rf
  build:
    needs: get_build_runner
    runs-on: ${{ needs.get_build_runner.outputs.test_host }}
    container:
      image: 'pytorch/manylinux2_28-builder:xpu-main'
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}
      options: -u ${{ needs.get_build_runner.outputs.test_user }}:${{ needs.get_build_runner.outputs.test_group }}
      env:
        PATH: /tmp/xpu-build/bin:/usr/share/Modules/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        GH_TOKEN: ${{ github.token }}
    timeout-minutes: 300
    steps:
      - name: Setup based env
        run: |
          # Cleanup workspace
          rm -rf ./*
          # Install gh
          dnf install 'dnf-command(config-manager)'
          dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
          dnf autoremove -y git236* && dnf install -y git
          dnf install gh --repo gh-cli -y
          # Setup python
          local_python=$(echo ${{ inputs.python }} |awk -F. '{printf("cp%s%s-cp%s%s", $1, $2, $1, $2)}')
          /opt/python/${local_python}/bin/python -m venv /tmp/xpu-build
          which python && python -V && pip list
          pip install -U pip wheel setuptools
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
        with:
          path: torch-xpu-ops
      - name: Build Pytorch XPU
        run: |
          set -xe -o pipefail
          if [[ "${{ inputs.pytorch }}" == *"https://"* ]];then
            PYTORCH_REPO="$(echo ${{ inputs.pytorch }} |sed 's/@.*//')"
            PYTORCH_COMMIT="$(echo ${{ inputs.pytorch }} |sed 's/.*@//')"
          else
            PYTORCH_REPO="https://github.com/pytorch/pytorch.git"
            PYTORCH_COMMIT="${{ inputs.pytorch }}"
          fi
          if [[ "${{ inputs.torch_xpu_ops }}" == *"https://"* ]];then
            TORCH_XPU_OPS_REPO="$(echo ${{ inputs.torch_xpu_ops }} |sed 's/@.*//')"
            TORCH_XPU_OPS_COMMIT="$(echo ${{ inputs.torch_xpu_ops }} |sed 's/.*@//')"
          else
            TORCH_XPU_OPS_REPO="https://github.com/intel/torch-xpu-ops.git"
            TORCH_XPU_OPS_COMMIT="${{ inputs.torch_xpu_ops }}"
          fi
          # oneAPI DLE
          if [ "${{ inputs.oneapi }}" != "installed" ];then
            rm -rf ${HOME}/intel ${HOME}/.intel
            wget -q -O oneapi.sh "${{ inputs.oneapi }}"
            bash oneapi.sh -a -s --eula accept --action install --install-dir ${HOME}/intel/oneapi
            export XPU_ONEAPI_PATH="${HOME}/intel/oneapi"
          fi
          source ${{ github.workspace }}/torch-xpu-ops/.github/scripts/env.sh
          # gcc 11
          source /opt/rh/gcc-toolset-11/enable
          ${{ github.workspace }}/torch-xpu-ops/.github/scripts/build.sh \
            --WORKSPACE="${{ github.workspace }}" \
            --PYTORCH_REPO="${PYTORCH_REPO}" \
            --PYTORCH_COMMIT="${PYTORCH_COMMIT}" \
            --TORCH_XPU_OPS_REPO="${TORCH_XPU_OPS_REPO}" \
            --TORCH_XPU_OPS_COMMIT="${TORCH_XPU_OPS_COMMIT}" \
            2>&1 |tee ${{ github.workspace }}/build_pytorch_${PYTORCH_COMMIT//\//-}.log
      - name: Build Triton
        run: |
          # gcc 13
          dnf install -y gcc-toolset-13-gcc-c++ zlib-devel
          source /opt/rh/gcc-toolset-13/enable
          cd ./pytorch
          pip install cmake ninja pybind11
          rm -rf pytorch_triton_xpu-*.whl
          if [ "${{ inputs.triton }}" != "pinned" ];then
            TRITON_COMMIT_ID="${{ inputs.triton }}"
          else
            TRITON_COMMIT_ID="$(cat .ci/docker/ci_commit_pins/triton-xpu.txt)"
          fi
          TRITON_VERSION_NAME="$(
            curl -sSL https://raw.githubusercontent.com/intel/intel-xpu-backend-for-triton/${TRITON_COMMIT_ID}/python/triton/__init__.py 2>&1 |\
                    grep '__version__' |head -n 1 |awk -F "'" '{print $2}'
          )"
          python .github/scripts/build_triton_wheel.py --device xpu --commit-hash ${TRITON_COMMIT_ID} --triton-version ${TRITON_VERSION_NAME} \
            2>&1 |tee ${{ github.workspace }}/build_triton_${TRITON_COMMIT_ID}.log
          pip install pytorch_triton_xpu-*.whl
          cp pytorch_triton_xpu-*.whl ${{ github.workspace }}
      - name: Build Torchvision and Torchaudio
        run: |
          cd ./pytorch
          TORCHVISION_COMMIT_ID="$(cat .github/ci_commit_pins/vision.txt)"
          TORCHAUDIO_COMMIT_ID="$(cat .github/ci_commit_pins/audio.txt)"
          git clone --single-branch -b main https://github.com/pytorch/vision.git xpu-vision
          cd xpu-vision && git checkout ${TORCHVISION_COMMIT_ID}
          python setup.py bdist_wheel 2>&1 |tee ${{ github.workspace }}/build_vision_${TRITON_COMMIT_ID}.log
          pip install dist/*.whl
          cp dist/*.whl ${{ github.workspace }}
          git clone --single-branch -b main https://github.com/pytorch/audio.git xpu-audio
          cd xpu-audio && git checkout ${TORCHAUDIO_COMMIT_ID}
          python setup.py bdist_wheel 2>&1 |tee ${{ github.workspace }}/build_audio_${TRITON_COMMIT_ID}.log
          pip install dist/*.whl
          cp dist/*.whl ${{ github.workspace }}
      - name: Torch Config
        run: |
          printenv
          python -c "import torch; print(torch.__config__.show())"
          python -c "import torch; print(torch.__config__.parallel_info())"
          python -c "import torch; print(torch.__config__.torch.xpu.device_count())"
          python -c "import triton; print(triton.__version__)"
          python -c "import torchvision; print(torchvision.__version__)"
          python -c "import torchaudio; print(torchaudio.__version__)"
          python pytorch/torch/utils/collect_env.py
          pip list |grep -E 'torch|intel'

      - name: Upload Torch XPU Wheel
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Torch-XPU-Wheel-${{ github.event.pull_request.number || github.sha }}
          path: ${{ github.workspace }}/*.whl
      - name: Upload Build Log
        if: ${{ ! cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: Torch-XPU-Build-Log-${{ github.event.pull_request.number || github.sha }}
          path: ${{ github.workspace }}/build_*.log
      - name: Cleanup
        if: always()
        run: |
          chmod 777 . -R
          rm -rf ./*
