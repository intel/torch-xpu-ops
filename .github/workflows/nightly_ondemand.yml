name: Nightly-OnDemand Tests

on:
  workflow_dispatch:
    inputs:
      node_name:
        type: string
        default: ''
        description: 'PVC-7362,PVC-7363,PVC-7364,PVC-7900,PVC-03004,PVC-03006'
      setup_xpu:
        type: string
        default: ''
        description: 'yes or not, not by default'

permissions: read-all

jobs:
  get-params:
    runs-on: ubuntu:24.04
    outputs:
      node_name: ${{ steps.params.outputs.node_name }}
    steps:
      - name: Get params
        id: params
        run: |
          echo "node_name='[${{ inputs.node_name }}]'" >> ${GITHUB_OUTPUT}

  setup-xpu:
    if: ${{ inputs.setup_xpu == 'yes' }}
    needs: get-params
    runs-on: ${{ matrix.node_name }}
    strategy:
      fail-fast: false
      matrix:
        node_name: ${{ fromJSON(needs.get-params.outputs.node_name) }}

    steps:
      - name: Checkout torch-xpu-ops
        uses: actions/checkout@v4
      - name: Install XPU
        run: |
          bash -xe install_xpu.sh lts2

  check-nodes-env:
    runs-on: ${{ matrix.node_name }}
    strategy:
      matrix:
        node_name: [PVC-03006, PVC-03004, PVC-7900, PVC-7901]
    name: check-nodes-env-for-${{ matrix.node_name }}
    needs: setup-xpu
    if: ${{ always() }}
    steps:
      - name: Check env
        run: |
          source activate base
          wget https://raw.githubusercontent.com/pytorch/pytorch/main/torch/utils/collect_env.py
          python collect_env.py
